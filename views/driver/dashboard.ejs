<%- include('../partials/header') %>
<style>
  .driver-header {
    background: linear-gradient(135deg, rgba(230, 126, 34, 0.15) 0%, rgba(243, 156, 18, 0.15) 100%);
    border: 1px solid rgba(230, 126, 34, 0.25);
    border-radius: 20px;
    padding: 32px;
    margin-bottom: 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 20px;
  }

  .driver-header-content h1 {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .driver-header-content p {
    color: #495057;
    font-size: 15px;
  }

  .driver-stat {
    text-align: center;
    padding: 16px 24px;
    background: white;
    border-radius: 12px;
    border: 1px solid rgba(230, 126, 34, 0.2);
    box-shadow: 0 4px 12px rgba(230, 126, 34, 0.1);
  }

  .driver-stat .value {
    font-size: 28px;
    font-weight: 800;
    background: linear-gradient(135deg, #e67e22, #f39c12);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .driver-stat .label {
    font-size: 12px;
    color: #868e96;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
  }

  .section-title {
    font-size: 20px;
    font-weight: 700;
    color: #212529;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-title svg {
    color: #e67e22;
    width: 24px;
    height: 24px;
  }

  .driver-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-group label {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .form-group label svg {
    width: 16px;
    height: 16px;
    color: #868e96;
  }

  .form-group input,
  .form-group select {
    background: #fff;
    border: 2px solid #e9ecef;
    color: #212529;
    padding: 14px 16px;
    border-radius: 12px;
    font-size: 15px;
    transition: all 0.2s;
  }

  .form-group input:focus,
  .form-group select:focus {
    border-color: #e67e22;
    box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.15);
    outline: none;
  }

  .form-group small {
    color: #868e96;
    font-size: 13px;
  }

  .form-full {
    grid-column: 1 / -1;
  }

  .info-card {
    background: linear-gradient(135deg, rgba(230, 126, 34, 0.1) 0%, rgba(243, 156, 18, 0.1) 100%);
    border: 1px solid rgba(230, 126, 34, 0.25);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .info-card svg {
    flex-shrink: 0;
    color: #e67e22;
  }

  .info-card p {
    color: #d35400;
    font-size: 14px;
    margin: 0;
  }

  .verify-section {
    background: linear-gradient(135deg, rgba(30, 58, 95, 0.08) 0%, rgba(52, 152, 219, 0.08) 100%);
    border: 2px solid rgba(30, 58, 95, 0.2);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .verify-section h3 {
    font-size: 18px;
    font-weight: 700;
    color: #212529;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .verify-section h3 svg {
    color: #1e3a5f;
  }

  .verify-form {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .verify-form .form-group {
    flex: 1;
    min-width: 200px;
  }

  .verify-form input {
    font-size: 18px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    text-align: center;
  }

  .verify-result {
    margin-top: 20px;
    padding: 20px;
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.15) 0%, rgba(32, 201, 151, 0.15) 100%);
    border: 1px solid rgba(40, 167, 69, 0.3);
    border-radius: 12px;
  }

  .verify-result h4 {
    color: #28a745;
    font-size: 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .verify-result .passenger-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }

  .verify-result .info-item {
    background: white;
    padding: 12px;
    border-radius: 8px;
  }

  .verify-result .info-item label {
    font-size: 11px;
    color: #868e96;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .verify-result .info-item span {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #212529;
    margin-top: 4px;
  }

  .verify-error {
    margin-top: 16px;
    padding: 16px;
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.1) 100%);
    border: 1px solid rgba(220, 53, 69, 0.3);
    border-radius: 12px;
    color: #dc3545;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .empty-trips {
    text-align: center;
    padding: 48px 24px;
    color: #868e96;
  }

  .empty-trips svg {
    width: 64px;
    height: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-trips h3 {
    font-size: 18px;
    color: #495057;
    margin-bottom: 8px;
  }

  .trip-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.2s;
  }

  .trip-card:hover {
    border-color: rgba(230, 126, 34, 0.3);
    box-shadow: 0 4px 12px rgba(230, 126, 34, 0.1);
  }

  .trip-route {
    font-size: 18px;
    font-weight: 700;
    color: #212529;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .trip-route::before {
    content: '';
    width: 10px;
    height: 10px;
    background: linear-gradient(135deg, #e67e22, #f39c12);
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
  }

  .trip-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
  }

  .trip-meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #495057;
    font-size: 14px;
  }

  .trip-meta-item svg {
    width: 16px;
    height: 16px;
    color: #868e96;
  }

  .trip-meta-item.price {
    color: #28a745;
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .driver-header {
      flex-direction: column;
      text-align: center;
    }

    .driver-form {
      grid-template-columns: 1fr;
    }

    .verify-form {
      flex-direction: column;
    }
  }
</style>

<main class="container">
  <!-- Driver Header -->
  <div class="driver-header">
    <div class="driver-header-content">
      <h1>Driver Dashboard</h1>
      <p>Manage your availability, verify passengers, and view your assigned trips</p>
    </div>
    <div class="driver-stat">
      <div class="value"><%= assignedTrips.length %></div>
      <div class="label">Assigned Trips</div>
    </div>
  </div>

  <!-- Verify Booking Section -->
  <div class="card verify-section">
    <h3>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <rect x="7" y="7" width="3" height="3"/>
        <rect x="14" y="7" width="3" height="3"/>
        <rect x="7" y="14" width="3" height="3"/>
        <rect x="14" y="14" width="3" height="3"/>
      </svg>
      Verify Passenger Booking
    </h3>
    <p style="color: #495057; margin-bottom: 16px;">Enter the booking code from the passenger's QR code to verify their ticket and confirm boarding.</p>

    <form method="post" action="/driver/verify-booking" class="verify-form">
      <div class="form-group">
        <label>Booking Code</label>
        <input type="text" name="booking_code" placeholder="e.g., LG-A1B2C3D4" required maxlength="12" />
      </div>
      <button type="submit" class="btn btn-primary" style="padding: 14px 28px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        Verify & Confirm Boarding
      </button>
    </form>

    <% if (verifyError) { %>
      <div class="verify-error">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <%= verifyError %>
      </div>
    <% } %>

    <% if (verifyResult) { %>
      <div class="verify-result">
        <h4>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          Passenger Verified Successfully - Ticket Used
        </h4>
        <div class="passenger-info">
          <div class="info-item">
            <label>Passenger Name</label>
            <span><%= verifyResult.passenger_name %></span>
          </div>
          <div class="info-item">
            <label>Email</label>
            <span><%= verifyResult.passenger_email %></span>
          </div>
          <div class="info-item">
            <label>Route</label>
            <span><%= verifyResult.origin %> - <%= verifyResult.destination %></span>
          </div>
          <div class="info-item">
            <label>Date</label>
            <span><%= verifyResult.date %></span>
          </div>
          <div class="info-item">
            <label>Booking Code (Used)</label>
            <span style="text-decoration: line-through; color: #868e96;"><%= verifyResult.booking_code %></span>
          </div>
        </div>
        <p style="margin-top: 16px; color: #28a745; font-size: 14px; font-weight: 500;">
          This ticket has been marked as used and the QR code is no longer valid.
        </p>
      </div>
    <% } %>
  </div>

  <!-- Driver Information Form -->
  <div class="section card">
    <h2 class="section-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      Driver Information & Availability
    </h2>

    <div class="info-card">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12.01" y2="8"/>
      </svg>
      <p>Fill in your details and availability to be assigned trips by the admin. Make sure to list all cities you can drive to/from.</p>
    </div>

    <form method="post" action="/driver/availability">
      <div class="driver-form">
        <div class="form-group">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            Full Name
          </label>
          <input required name="full_name" placeholder="Your full name" value="<%= driverInfo ? driverInfo.full_name : '' %>"/>
        </div>

        <div class="form-group">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            ID Number
          </label>
          <input required name="id_number" placeholder="Your ID number" value="<%= driverInfo ? driverInfo.id_number : '' %>"/>
        </div>

        <div class="form-group">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            Available Date
          </label>
          <input required name="available_date" type="date" value="<%= driverInfo ? driverInfo.available_date : '' %>"/>
        </div>

        <div class="form-group">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            Available Time
          </label>
          <input required name="available_time" type="time" value="<%= driverInfo ? driverInfo.available_time : '' %>"/>
        </div>

        <div class="form-group">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            Cities (comma-separated)
          </label>
          <input required name="cities" placeholder="e.g., Tunis, Sousse, Sfax" value="<%= driverInfo ? driverInfo.cities : '' %>"/>
          <small>List all cities you can drive to/from</small>
        </div>

        <div class="form-group">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 17H5a2 2 0 0 0-2 2 2 2 0 0 0 2 2h2a2 2 0 0 0 2-2zm12-2h-4a2 2 0 0 0-2 2 2 2 0 0 0 2 2h2a2 2 0 0 0 2-2z"/>
              <path d="M17 17V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h8"/>
              <circle cx="7.5" cy="17" r="2.5"/>
              <circle cx="17.5" cy="17" r="2.5"/>
            </svg>
            Vehicle Model
          </label>
          <select required name="vehicle_model">
            <option value="">Select Vehicle Model</option>
            <option value="Toyota" <%= driverInfo && driverInfo.vehicle_model === 'Toyota' ? 'selected' : '' %>>Toyota</option>
            <option value="Nissan" <%= driverInfo && driverInfo.vehicle_model === 'Nissan' ? 'selected' : '' %>>Nissan</option>
            <option value="Iveco" <%= driverInfo && driverInfo.vehicle_model === 'Iveco' ? 'selected' : '' %>>Iveco</option>
          </select>
        </div>

        <div class="form-group form-full">
          <button class="btn btn-success" style="width: 100%; padding: 14px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            Save Availability
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Assigned Trips -->
  <div class="section card">
    <h2 class="section-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="3 11 22 2 13 21 11 13 3 11"/>
      </svg>
      My Assigned Trips
    </h2>

    <% if (assignedTrips.length === 0) { %>
      <div class="empty-trips">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <path d="M8 15h8"/>
          <path d="M9 9h.01"/>
          <path d="M15 9h.01"/>
        </svg>
        <h3>No trips assigned yet</h3>
        <p>The admin will assign trips to you based on your availability and location.</p>
      </div>
    <% } else { %>
      <div style="max-height: 500px; overflow-y: auto;">
        <% assignedTrips.forEach(trip => { %>
          <div class="trip-card">
            <div class="trip-route"><%= trip.origin %> - <%= trip.destination %></div>
            <div class="trip-meta">
              <div class="trip-meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <%= trip.date %>
              </div>
              <div class="trip-meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                <%= trip.departure_time %>
              </div>
              <div class="trip-meta-item price">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="1" x2="12" y2="23"/>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                <%= trip.price %> TND
              </div>
              <div class="trip-meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <%= trip.seats %> seats
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
</main>
<%- include('../partials/footer') %>
